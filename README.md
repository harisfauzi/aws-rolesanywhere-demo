# README

This repo has the demo code to create some resources for AWS IAM Roles Anywhere. It can and should be used to access AWS without creating IAM User and access key (which can cause security issues).

## Requirements

- Linux/MacOS
- python >= 3.7
- curl
- jq
- virtualenv (from Python)
- An X.509v3 certificate from your private Root CA, in the PEM format (base64 encoded). See [this blog post](https://haris.fauzi.org/?p=126) to quickly setup one for testing.

## Preparation

1. Clone this repo.
2. Setup Python virtual environment.
    ```shell
    virtualenv .venv -p <path to your python, e.g. /usr/bin/python3.8>
    source .venv/bin/activate
    ```
3. Install required python modules (sceptre, awscli, etc) from `requirements.txt`.
    ```shell
    pip install -r requirements.txt
    ```
    Then check if sceptre is installed and ready to be used.
    ```shell
    command -v sceptre
    sceptre --version
    ```
    Ensure sceptre is located under your virtual environment directory and the version matches the one defined in `requirements.txt`.
4. Put the Root CA certificate in a variable file. Please create a file under `sceptre/vars/` directory, place the content of the certificate file in a variable named `root_ca_certificate`. Please see [demo-environment.yaml](sceptre/vars/demo-environment.yaml) for reference (including the `|` character), e.g. put it in a file named `myrootca.yaml`.
5. Inspect [iam-role.yaml](sceptre/config/infra/iam-role.yaml) and edit as necessary. You probably don't want to assign PowerUserAccess policy to the role.
6. Set your access to AWS account for deployment and set the required [environment variables](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html) to allow access to the target deployment AWS account. You need to use either AWS_PROFILE or the combination of `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, and optionally `AWS_SESSION_TOKEN` if you use short term credential. You also need to define `AWS_DEFAULT_REGION` to set your AWS region. Once all these environment variables are set, test your access by running:
    ```shell
    aws sts get-caller-identity
    ````

## Deployment

This repo uses [shared-sceptre-templates](https://github.com/harisfauzi/shared-sceptre-template), which means the actual CloudFormation templates will be generated on-the-fly by sceptre and it will use the Jinja2 templates provided in that repo. This is why the `templates` directory is almost empty, except for the placeholder file to ensure the directory exists when the repo is cloned.

Continuing from the preparation steps, run the following:
   ```shell
   VARIABLE_FILE=myrootca.yaml  # or whatever filename you use to put the Root CA certificate.
   ACTION=deploy
   DRY_RUN=false
   ./deploy-cfn-nodocker.sh \
     --var-file "${VARIABLE_FILE}" \
     --action "${ACTION}" \
     --dry-run "${ACTION}" \
     --extra-vars "aws_region=${AWS_DEFAULT_REGION}" \
     --item infra  # This the directory name under sceptre/config that has all the cloudformation that we want to deploy
   ```

## Using IAM Roles Anywhere

Check [the guide](https://docs.aws.amazon.com/rolesanywhere/latest/userguide/credential-helper.html) on complete reference on how to use IAM Roles Anywhere.

Quick setup:

1. Download `aws_signing_helper` that matches your OS from the links in the guide.
2. Grab the Roles Anywhere Profile ARN, Trust Anchor ARN, and the IAM Role ARN that were generated by CloudFormation. You can find them in the Outputs section of the stacks.
3. If you follow [the blog post](https://haris.fauzi.org/?p=126) to create your own PKI, you should proceed until you have a `client` type certificate. Once you get that certificate signed by the Intermediate CA, grab the Intermediate CA certificate file, the private key file (for the client certificate), and the client certificate file signed by the certificate. Place all these files under one directory. 
4. On the directory where you place the files, ensure you have access to `aws_signing_helper` from step 1 (or you can place it in `/usr/local/bin`), test if the trust has been established:

    ```shell
    # Setup variables
    AWS_SIGNING_HELPER=/usr/local/bin/aws_signing_helper  # Or wherever you place it
    CERTIFICATE_FILE=<your certificate file>
    KEY_FILE=<your private key file>
    CA_FILE=<your intermediate CA certificate file>
    TRUST_ANCHOR_ARN=<the Roles Anywhere Trust Anchor ARN>
    PROFILE_ARN=<the Roles Anywhere Profile ARN>
    ROLE_ARN=<the IAM Role ARN>

    CREDENTIALS=$(${AWS_SIGNING_HELPER} credential-process \
      --certificate "${CERTIFICATE_FILE}" \
      --private-key "${KEY_FILE}" \
      --intermediates "${CA_FILE}" \
      --trust-anchor-arn "${TRUST_ANCHOR_ARN}" \
      --profile-arn "${PROFILE_ARN}" \
      --role-arn "${ROLE_ARN}" \
      --region "${AWS_DEFAULT_REGION}")
    ```
    That should work without error. Then to see if it received proper credentials, run the output through jq:
    ```shell
    echo "${CREDENTIALS}" | jq -r '.'
    ```

## Real World Usage
To quickly utilise that IAM role with a specific AWS profile on your machine, follow the sample in [Example Use temporary security credentials with AWS SDKs and the AWS CLI](https://docs.aws.amazon.com/rolesanywhere/latest/userguide/credential-helper.html#credential-helper-examples).

1. Create/update the file `~/.aws/config` (or `%USERPROFILE%\.aws\config` on Windows).
2. Add the following to that file (replace `myprofile` with your actual profile name and other variables inside <> with the actual values):
    ```ini
    [profile myprofile]
      credential_process = <path to aws_signing_helper> credential-process --certificate <path to the client certificate> --private-key <path to client private key> --intermediates <path to intermediate CA certificate> --trust-anchor-arn <Roles Anywhere Trust Anchor ARN> --profile-arn <Roles Anywhere Profile ARN> --role-arn <IAM Role ARN> --region <your selected AWS region>
    ```
3. Test the AWS profile by running:
    ```shell
    aws sts get-caller-identity --profile myprofile --region us-west-2  # Or whatever profile name you set in ~/.aws/config
    ```
4. You can then use that AWS profile as usual, either by passing the `--profile` argument in AWS CLI or by defining `AWS_PROFILE` environment variable to that profile name.
